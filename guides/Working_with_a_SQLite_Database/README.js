Ext.data.JsonP['Working_with_a_SQLite_Database']({"guide":"<?xml version='1.0' encoding='utf-8'?>\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\"\n        \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n<head>\n<title>Working with a SQLite Database</title>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" />\n<meta content=\"Scroll EclipseHelp Exporter\" name=\"generator\" />\n<link type=\"text/css\" rel=\"stylesheet\" />\n<link type=\"text/css\" rel=\"stylesheet\" />\n<link type=\"text/css\" rel=\"stylesheet\" media=\"print\" />\n</head>\n<body>\n<div class=\"container\">\n<div class=\"header\"></div>\n<div id=\"29004901\" class=\"content\"><a id=\"editButton\" href=\"https://wiki.appcelerator.org/pages/editpage.action?pageId=29004901\"><span>Edit</span></a>\n<h1>Working with a SQLite Database</h1>\n<div class=\"section section-2 \" id=\"29004901_WorkingwithaSQLiteDatabase-Objective\">\n<h2 class=\"heading \"><span>Objective</span></h2>\n<p>\nIn this chapter, you will learn how to interact with the built-in SQLite3 RDMS with the <tt class=\" \">Ti.Database</tt> module. You'll learn how to create databases and tables. You'll retrieve data. And you'll store data in the database.    </p>\n</div>\n<div class=\"section section-2 \" id=\"29004901_WorkingwithaSQLiteDatabase-Contents\">\n<h2 class=\"heading \"><span>Contents</span></h2>\n<p>\nSQLite3 is version 3 of SQLite's SQL-based relational database management system (RDMS), chosen by Apple, Google and RIM to provide local data storage on their mobile devices. SQLite is currently the world's most widely-used database. It owes it's popularity to its open source code, low resource footprint and, as it does not rely on any installed services unlike almost all other DBMSs, its simplicity of setup and maintenance.    </p>\n<p>\nThere are a few things to note when you first work with SQLite, that may influence the way you develop with it:    </p>\n<ul class=\" \"><li class=\" \"> <p>\nSQLite's data is stored in a simple text file. There is no granular security or user privileges for data. Anyone with filesystem access to it may read its contents.    </p>\n</li><li class=\" \"> <p>\nThere are only five underlying data types; TEXT, NUMERIC, INTEGER, REAL, NONE. <a class=\"external-link external-link\" href=\"http://www.sqlite.org/datatype3.html\" target=\"_blank\">Datatypes In SQLite</a> explains them in more detail.    </p>\n</li><li class=\" \"> <p>\nBinary objects (BLOBs) are stored as text representations, thus access to BLOBs is not optimal. We recommend you store BLOBs on the filesystem and store the filesystem path in the database.    </p>\n</li><li class=\" \"> <p>\nSQLite supports concurrent read access, but enforces sequential write access. This is because a filesystem lock is placed on the file during write operations. This is an important point to bear in mind with multi-threaded applications.    </p>\n</li><li class=\" \"> <p>\nReferential integrity is not enabled by default. See <a class=\"external-link external-link\" href=\"http://www.sqlite.org/foreignkeys.html\" target=\"_blank\">SQLite Foreign Key Support</a> for more information.    </p>\n</li><li class=\" \"> <p>\nRIGHT and FULL OUTER JOINs are not supported.    </p>\n</li><li class=\" \"> <p>\nThere is limited ALTER TABLE support; columns may not be modified or deleted.    </p>\n</li></ul> <p>\nTitanium provides access to SQLite via its <a class=\"external-link external-link\" href=\"#!/api/Titanium.Database\">Titanium.Database</a> module that returns the <a class=\"external-link external-link\" href=\"#!/api/Titanium.Database.DB\">Titanium.Database.DB</a> object, for installing and opening databases and executing queries, and the <a class=\"external-link external-link\" href=\"#!/api/Titanium.Database.ResultSet\">Titanium.Database.ResultSet</a> object, which holds the data returned from those queries.    </p>\n<div class=\"section section-3 \" id=\"29004901_WorkingwithaSQLiteDatabase-CreatingandInstallingDatabases\">\n<h3 class=\"heading \"><span>Creating and Installing Databases</span></h3>\n<p>\nYou have a couple of options for creating or installing the database that your application will use:    </p>\n<ul class=\" \"><li class=\" \"> <p>\nCreate an empty database and define its structure and contents via SQL statements embedded within your app.    </p>\n</li><li class=\" \"> <p>\nInstall a predefined database (with or without data) that is shipped with your app.    </p>\n</li></ul> <div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-Creatingadatabase\">\n<h4 class=\"heading \"><span>Creating a database</span></h4>\n<p>\nTo create a database, you'll use the <tt class=\" \">Titanium.Database.open()</tt> method &ndash; if the database you specify to open doesn't exist, Titanium will create it for you. Whether the database exists or Titanium creates it for you, this call will return a database connection handle that you'll use in subsequent database operations.    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"plain\">var db = Ti.Database.open(</code><code class=\"string\">'weatherDB'</code><code class=\"plain\">);</code></div>\n</div>\n</div> <p>\nThere are a few platform specifics:    </p>\n<p>\n<span id=\"29004901_WorkingwithaSQLiteDatabase-filelocations\"><a class=\"confluence-anchor-link\" name=\"29004901_WorkingwithaSQLiteDatabase-filelocations\"></a></span>\n</p>\n<ul class=\" \"><li class=\" \"> <p>\nOn iOS, the database file that's created is automatically assigned the .sql extension, while on Android no extension is added.    </p>\n</li><li class=\" \"> <p>\nOn iOS 5, database files are stored in the app's Private Documents folder (on device); on iOS 4, it is stored in the Application Support/database folder.    </p>\n</li><li class=\" \"> <p>\nOn iOS 5.0.1+, the database will be included in any other user data backed up to iCloud. See below for more info.    </p>\n</li><li class=\" \"> <p>\nOn Android, the database is created on the internal storage (you could move it, or use the install procedure to put it on external storage). The standard location on internal storage is /data/data/<i class=\" \">com.example.yourappid</i>/databases/<i class=\" \">dbname</i> </p>\n</li></ul> <p>\nOnce you have created a database, your next step would be to get your structure set up. Titanium does not include abstraction libraries; you'll interact with the database using standard SQL statements. You can use the <tt class=\" \">CREATE TABLE IF NOT EXISTS</tt> statement to safely create tables &ndash; if they already exist, the statement will be ignored. (Don't know SQL? There are lots of tutorials available, such as <a class=\"external-link external-link\" href=\"http://www.sql-tutorial.net/\" target=\"_blank\">this one</a>, <a class=\"external-link external-link\" href=\"http://www.sqltutorial.org/\" target=\"_blank\">this one</a>, or this <a class=\"external-link external-link\" href=\"https://www.google.com/search?aq=f&amp;sourceid=chrome&amp;ie=UTF-8&amp;q=learning+sql#pq%3Dlearning+sql%26hl%3Den%26tok%3DSEyJfQ8VNa_MEqbCkjCYZg%26cp%3D5%26gs_id%3D14%26xhr%3Dt%26q%3Dsql+tutorial%26pf%3Dp%26sclient%3Dpsy-ab%26source%3Dhp%26pbx%3D1%26oq%3Dsql+t%26aq%3D0%26aqi%3Dg4%26aql%3D%26gs_sm%3D%26gs_upl%3D%26bav%3Don.2%2Cor.r_gc.r_pw.r_cp.%2Ccf.osb%26fp%3D862141011cc102a%26biw%3D1568%26bih%3D883\" target=\"_blank\">Google search resultset</a>.)    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"comments\">//bootstrap the database</code></div>\n<div class=\"line\"><code class=\"plain\">var db = Ti.Database.open(</code><code class=\"string\">'TiBountyHunter'</code><code class=\"plain\">);</code></div>\n<div class=\"line\"><code class=\"plain\">db.execute(</code><code class=\"string\">'CREATE TABLE IF NOT EXISTS fugitives(id INTEGER PRIMARY KEY, name TEXT, captured INTEGER, url TEXT, capturedLat REAL, capturedLong REAL);'</code><code class=\"plain\">);</code></div>\n<div class=\"line\"><code class=\"plain\">db.close();</code></div>\n</div>\n</div> <p>\nYou might notice that we closed the database when done. Closing database connections and resultsets is important to do for performance reasons. You're dealing with a single-user, memory constrained environment in which connection pooling is not important. The time to open/close connections is less of a hit that consuming memory by keeping connections open.    </p>\n<div class=\"section section-5 \" id=\"29004901_WorkingwithaSQLiteDatabase-ControllingbackupstoiCloud\">\n<h5 class=\"heading \"><span>Controlling backups to iCloud</span></h5>\n<p>\nApps may be rejected by Apple for backing up unnecessary or inappropriate files. To avoid this rejection, you can mark files and databases so that they're not backed up.    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"plain\">var db = Ti.Database.open(</code><code class=\"string\">'TiBountyHunter'</code><code class=\"plain\">);</code></div>\n<div class=\"line\"><code class=\"plain\">db.file.setRemoteBackup(</code><code class=\"keyword\">false</code><code class=\"plain\">);</code></div>\n</div>\n</div> <p>\nThis value should only need to be set once by your app, but setting it multiple times will not cause problems. For files distributed with your app, this will need to be set on app startup. This flag will only affect iOS versions 5.0.1 and later, but is safe to set on earlier versions. Note that setting this property to <tt class=\" \">false</tt> will also prevent the file identified by this object from being backed up to iTunes.    </p>\n<p>\nFor more information, see:    </p>\n<ul class=\" \"><li class=\" \"> <p>\nDatabase <a class=\"external-link external-link\" href=\"#!/api/Titanium.Database.DB-property-file\">file property</a> </p>\n</li><li class=\" \"> <p>\nThe <a class=\"external-link external-link\" href=\"#!/api/Titanium.Filesystem.File-method-setRemoteBackup\">setRemoteBackup() method</a> </p>\n</li><li class=\" \"> <p>\nApple <a class=\"external-link external-link\" href=\"https://developer.apple.com/library/iOS/qa/qa1719/_index.html\" target=\"_blank\">Technical Q&amp;A 1719</a> describes the types of data that should or should not be backed up    </p>\n</li></ul> </div>\n</div>\n<div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-Installingadatabase\">\n<h4 class=\"heading \"><span>Installing a database</span></h4>\n<p>\nYour other option is to install a pre-existing database (we'll cover how to create a SQLite database later in this guide). For that, you'll use the <tt class=\" \">install()</tt> method copy a pre-existing database file from Titanium's <tt class=\" \">Resources</tt> directory, or one of its descendants, to the appropriate directory on the device/simulator. As with <tt class=\" \">open()</tt>, this method returns a reference to the opened database. If a file already exists with the same name, the copy action will silently fail and the database will simply be opened (and reference returned).    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"plain\">var db = Ti.Database.install(</code><code class=\"string\">'/mydata/weatherDB'</code><code class=\"plain\">, </code><code class=\"string\">'weatherDB'</code><code class=\"plain\">);</code></div>\n</div>\n</div> <p>\nIn this example, <tt class=\" \">weatherDB</tt>, initially stored in the <tt class=\" \">Resources/mydata/</tt> directory, will be copied to the application's databases directory (see <a class=\"document-link \" href=\"#!/guide/Working_with_a_SQLite_Database-section-29004901_WorkingwithaSQLiteDatabase-filelocations\" Working_with_a_SQLite_Database.html#29004901_WorkingwithaSQLiteDatabase-filelocations=\"Working_with_a_SQLite_Database.html#29004901_WorkingwithaSQLiteDatabase-filelocations\">notes above</a> on where that is). We recommend you spell out the absolute path to the database file, with / corresponding to your app's Resources directory. If you do not, the source file might not be found. On Android, the system will create an empty database with the given name. But since it contains no tables, your app will crash on your first attempt at access the database.    </p>\n<div class=\"section section-5 \" id=\"29004901_WorkingwithaSQLiteDatabase-CreatingaSQLitedatabase\">\n<h5 class=\"heading \"><span>Creating a SQLite database</span></h5>\n<p>\nYou'll need some sort of tool to create your SQLite database. There are many to choose from, both commercial and free. One of the most popular is the <a class=\"external-link external-link\" href=\"https://addons.mozilla.org/en-US/firefox/addon/sqlite-manager/\" target=\"_blank\">SQLite Manager plugin for Firefox</a>. The SQLite project maintains a rather large <a class=\"external-link external-link\" href=\"http://www.sqlite.org/cvstrac/wiki?p=ManagementTools\" target=\"_blank\">list of management tools</a> on their site, too.    </p>\n</div>\n</div>\n</div>\n<div class=\"section section-3 \" id=\"29004901_WorkingwithaSQLiteDatabase-ManipulatingDBContents\">\n<h3 class=\"heading \"><span>Manipulating DB Contents</span></h3>\n<p>\nSQLite (and by extension Titanium) supports a fairly complete list of SQL statements. You'll use these to manipulate the data in your database. Typical tasks include inserting new data, retrieving data, updating data, and deleting data.    </p>\n<div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-Storingdata\">\n<h4 class=\"heading \"><span>Storing data</span></h4>\n<p>\nIn order to insert records to a database, you should pass an SQL <tt class=\" \">INSERT</tt> statement to the <tt class=\" \">execute()</tt> method. While you could use string concatenation to construct the <tt class=\" \">INSERT</tt> statement, SQLite and Titanium's <tt class=\" \">execute()</tt> method support the safer technique of using unnamed parameterized queries. In other words, you enter question marks as placemarkers where you would like each variable containing your data to be substituted, as follows:    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"plain\">db.execute(</code><code class=\"string\">'INSERT INTO city (name,continent,temp_f,temp_c,condition_id) VALUES (?,?,?,?,?)'</code><code class=\"plain\">, importName, importContinent, importTempF, importTempC, dbConditionId);</code></div>\n</div>\n</div> <p>\nIt's commonplace for tables to include an auto-incrementing primary key, representing a unique ID for each row. You would typically use such IDs to access individual rows to update them or delete them. You can obtain the row ID associated with a newly inserted row by examining the <tt class=\" \">lastInsertRowID</tt> property, like this:    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"plain\">db.execute(</code><code class=\"string\">'INSERT INTO city (name,continent,temp_f,temp_c,condition_id) VALUES (?,?,?,?,?)'</code><code class=\"plain\">, importName, importContinent, importTempF, importTempC, dbConditionId);</code></div>\n<div class=\"line\"><code class=\"plain\">var lastID = db.lastInsertRowID; </code><code class=\"comments\">// presumes `city` has an auto-increment column</code></div>\n</div>\n</div> </div>\n<div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-Retrievingdata\">\n<h4 class=\"heading \"><span>Retrieving data</span></h4>\n<p>\nYou can retrieve data from the database using a typical SQL <tt class=\" \">SELECT</tt> query, passed to <tt class=\" \">execute()</tt> like the examples above. This method returns a <a class=\"external-link external-link\" href=\"#!/api/Titanium.Database.ResultSet\">Titanium.Database.ResultSet</a> object, which you use to access the queried data.    </p>\n<p>\n(The <tt class=\" \">execute()</tt> method always returns a result set object, but it's not all that useful with <tt class=\" \">CREATE TABLE</tt> and other queries shown previously.)    </p>\n<p>\nThe result set data is available using the methods that the <a class=\"external-link external-link\" href=\"#!/api/Titanium.Database.ResultSet\">Titanium.Database.ResultSet</a> object provides. In the following code, a loop is used to iterate through each row, and only ends when <tt class=\" \">isValidRow()</tt> returns false. The <tt class=\" \">fieldByName()</tt> method allows you to refer to each field by its database column name, or an alias you assign in the SQL statement. At each iteration of the loop, it is necessary to move the ResultSet row pointer to the next row, using the <tt class=\" \">next()</tt> method.    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"plain\">var cityWeatherRS = db.execute(</code><code class=\"string\">'SELECT id,name,continent FROM city'</code><code class=\"plain\">);</code></div>\n<div class=\"line\"><code class=\"keyword\">while</code><code class=\"plain\"> (cityWeatherRS.isValidRow())</code></div>\n<div class=\"line\"><code class=\"plain\">{</code></div>\n<div class=\"line\"><code class=\"plain\">  var cityId = cityWeatherRS.fieldByName(</code><code class=\"string\">'id'</code><code class=\"plain\">);</code></div>\n<div class=\"line\"><code class=\"plain\">  var cityName = cityWeatherRS.fieldByName(</code><code class=\"string\">'name'</code><code class=\"plain\">);</code></div>\n<div class=\"line\"><code class=\"plain\">  var cityContinent = cityWeatherRS.fieldByName(</code><code class=\"string\">'continent'</code><code class=\"plain\">);</code></div>\n<div class=\"line\"><code class=\"plain\">  Ti.API.info(cityId + </code><code class=\"string\">' '</code><code class=\"plain\"> + cityName + </code><code class=\"string\">' '</code><code class=\"plain\"> + cityContinent);</code></div>\n<div class=\"line\"><code class=\"plain\">  cityWeatherRS.next();</code></div>\n<div class=\"line\"><code class=\"plain\">}</code></div>\n<div class=\"line\"><code class=\"plain\">cityWeatherRS.close();</code></div>\n</div>\n</div> <p>\nYou may join related tables together, just as you would in standard SQL. The following returns all the <tt class=\" \">city</tt> records and includes the weather conditions summary for each, if it exists.    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"plain\">db.execute(</code><code class=\"string\">'SELECT city.id,name,cond.id,cond.summary,cond.icon FROM city LEFT JOIN condition cond WHERE city.condition_id = cond.id'</code><code class=\"plain\">);</code></div>\n</div>\n</div> <p>\nOf course, you can select subsets of data by providing conditions within your <tt class=\" \">SELECT</tt> statements. For example, the following returns only those records where the weather summary is &quot;Partly Cloudy&quot;:    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"plain\">var cityWeatherRS = db.execute(</code><code class=\"string\">'SELECT city.id AS city_id,name,cond.id AS cond_id,cond.summary,cond.icon FROM city LEFT JOIN condition cond WHERE city.condition_id = cond.id WHERE cond.summary=?'</code><code class=\"plain\">, </code><code class=\"string\">\"Partly Cloudy\"</code><code class=\"plain\">);</code></div>\n</div>\n</div> <p>\nNotice here that the <tt class=\" \">city.id</tt> and <tt class=\" \">cond.id</tt> columns have been aliased. This is because the <tt class=\" \">fieldByName()</tt> method would not be able to distinguish between them if you simply passed their column name, <tt class=\" \">fieldByName(id)</tt>. Thus, the ResultSet code would look like this:    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"keyword\">while</code><code class=\"plain\"> (cityWeatherRS.isValidRow())</code></div>\n<div class=\"line\"><code class=\"plain\">{</code></div>\n<div class=\"line\"><code class=\"plain\">  var cityId = cityWeatherRS.fieldByName(</code><code class=\"string\">'city_id'</code><code class=\"plain\">);</code></div>\n<div class=\"line\"><code class=\"plain\">  var cityName = cityWeatherRS.fieldByName(</code><code class=\"string\">'name'</code><code class=\"plain\">);</code></div>\n<div class=\"line\"><code class=\"plain\">  var cityConditionId = cityWeatherRS.fieldByName(</code><code class=\"string\">'cond_id'</code><code class=\"plain\">);</code></div>\n<div class=\"line\"><code class=\"plain\">  var cityConditionSummary = cityWeatherRS.fieldByName(</code><code class=\"string\">'summary'</code><code class=\"plain\">);</code></div>\n<div class=\"line\"><code class=\"plain\">  var cityConditionIcon = cityWeatherRS.fieldByName(</code><code class=\"string\">'icon'</code><code class=\"plain\">);</code></div>\n<div class=\"line\"><code class=\"plain\">  Ti.API.info(cityId + </code><code class=\"string\">' '</code><code class=\"plain\"> + cityName + </code><code class=\"string\">' '</code><code class=\"plain\"> + cityConditionId + </code><code class=\"string\">' '</code><code class=\"plain\"> + cityConditionSummary + </code><code class=\"string\">' '</code><code class=\"plain\"> + cityConditionIcon);</code></div>\n<div class=\"line\"><code class=\"plain\">  cityWeatherRS.next();</code></div>\n<div class=\"line\"><code class=\"plain\">}</code></div>\n<div class=\"line\"><code class=\"plain\">cityWeatherRS.close();</code></div>\n</div>\n</div> </div>\n<div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-Updatingdata\">\n<h4 class=\"heading \"><span>Updating data</span></h4>\n<p>\nTo update a database row you would use the <tt class=\" \">UPDATE</tt> statement along with parameterized queries as shown above for inserting data. For example:    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"plain\">db.execute(</code><code class=\"string\">'UPDATE condition SET icon=? WHERE id=?'</code><code class=\"plain\">,importIcon,dbConditionId);</code></div>\n</div>\n</div> </div>\n<div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-Deletingdata\">\n<h4 class=\"heading \"><span>Deleting data</span></h4>\n<p>\nYou can delete one or more rows from a table using the <tt class=\" \">DELETE</tt> statement. Make sure to supply a condition or all rows in the table will be deleted. SQLite also supports the <tt class=\" \">DROP TABLE</tt> syntax to remove an entire table from the database.    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"plain\">db.execute(</code><code class=\"string\">'DELETE FROM city WHERE id=?'</code><code class=\"plain\">,cityId);</code></div>\n</div>\n</div> </div>\n<div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-Truncating(emptying)atable\">\n<h4 class=\"heading \"><span>Truncating (emptying) a table</span></h4>\n<p>\nYou can empty a table of all its contents, but SQLite doesn't include the typical TRUNCATE command to do so. You use the <tt class=\" \">DELETE</tt> command:    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"plain\">db.execute(</code><code class=\"string\">'DELETE FROM city'</code><code class=\"plain\">); </code><code class=\"comments\">// would empty the table!</code></div>\n</div>\n</div> </div>\n</div>\n<div class=\"section section-3 \" id=\"29004901_WorkingwithaSQLiteDatabase-ManipulatingtheDatabase'sStructure\">\n<h3 class=\"heading \"><span>Manipulating the Database's Structure</span></h3>\n<p>\nSQLite supports various commands for modifying an existing database. These include: DROP, ALTER, and the PRAGMA commands.    </p>\n<div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-Droppingatable\">\n<h4 class=\"heading \"><span>Dropping a table</span></h4>\n<p>\nDropping a table removes it from the database. You can't recover it or undo your action once it's done. To prevent an error from being thrown if the table is already deleted, you can add the IF EXISTS clause:    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"plain\">db.execute(</code><code class=\"string\">'DROP TABLE IF EXISTS tablename'</code><code class=\"plain\">);</code></div>\n</div>\n</div> </div>\n<div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-Alteringatable\">\n<h4 class=\"heading \"><span>Altering a table</span></h4>\n<p>\nSQLite supports a limited subset of the ALTER TABLE command. You can add columns or rename a table. But, you cannot remove or rename a column from a table. These are both supported commands:    </p>\n<ul class=\" \"><li class=\" \"> <p>\nALTER <i class=\" \">tablename</i> ADD COLUMN <i class=\" \">column_definition</i> </p>\n</li><li class=\" \"> <p>\nALTER <i class=\" \">tablename</i> RENAME TO <i class=\" \">newname</i> &ndash; to rename a table    </p>\n</li></ul> <p>\n(To be clear, not being able to remove or rename columns is a SQLite limitation, not a Titanium limit.)    </p>\n</div>\n<div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-PRAGMAcommands\">\n<h4 class=\"heading \"><span>PRAGMA commands</span></h4>\n<p>\nThe <a class=\"external-link external-link\" href=\"http://www.sqlite.org/pragma.html\" target=\"_blank\">PRAGMA commands</a> provide SQLite-specific tools for determining the structure of the database and its tables and to set database operation parameters. Of these, only a few are useful in a mobile OS environment. These include table_info(), index_list(), integrity_check(), and so forth. See the SQLite site for the full list of commands.    </p>\n</div>\n</div>\n<div class=\"section section-3 \" id=\"29004901_WorkingwithaSQLiteDatabase-BestPractices\">\n<h3 class=\"heading \"><span>Best Practices</span></h3>\n<p>\nWe recommend the following as best practices:    </p>\n<ul class=\" \"><li class=\" \"> <p>\nClose database connections and resultsets as soon as you're done with them.    </p>\n</li><li class=\" \"> <p>\nBatch inserts/updates by wrapping them in a transaction.    </p>\n</li><li class=\" \"> <p>\nDon't ship a large pre-populated database with your app, download it instead    </p>\n</li><li class=\" \"> <p>\nStore a version number in your database for easier app updating.    </p>\n</li></ul> <div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-Closethedatabaseandresultsetwitheachoperation\">\n<h4 class=\"heading \"><span>Close the database and resultset with each operation</span></h4>\n<p>\nIn a mobile app, you're dealing with a single-user, memory constrained environment in which connection pooling is not important. The time to open/close connections is less of a hit that consuming memory by keeping connections open.    </p>\n<p>\nFurthermore, SQLite enforces sequential write-access to the database (one process at a time). This makes it vital that you close the database connection when you have completed any <tt class=\" \">INSERT</tt> or <tt class=\" \">UPDATE</tt> operations. If you don't, you might receive &quot;DatabaseObjectNotClosed&quot; exceptions when your script next attempts to write to it.    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"plain\">cityWeatherRS.close(); </code><code class=\"comments\">// close the resultset when you're done reading from it</code></div>\n<div class=\"line\"><code class=\"plain\">db.close(); </code><code class=\"comments\">// and close the database connection</code></div>\n</div>\n</div> </div>\n<div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-Usetransactionstospeedbatchinserts\">\n<h4 class=\"heading \"><span>Use transactions to speed batch inserts</span></h4>\n<p>\nA (perhaps not so widely known) trick in the database world is to use <a class=\"external-link external-link\" href=\"http://www.sqlteam.com/article/introduction-to-transactions\" target=\"_blank\">transactions</a> to speed up inserts. Let's say you have a loop that does ten inserts or updates. By wrapping them in a transaction, you create a single, mass operation against the database rather than ten little operations. The single operation can be significantly faster than those individual updates. The downside is that if any of the updates fail, the entire batch is rolled back.    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"comments\">// you get a bunch of data, maybe from the network, to save in the db</code></div>\n<div class=\"line\"><code class=\"plain\">var playlist = [];</code></div>\n<div class=\"line\"><code class=\"plain\">playlist.push({disc:</code><code class=\"string\">'Leon Live'</code><code class=\"plain\">, artist:</code><code class=\"string\">'Leon Russell'</code><code class=\"plain\">, comment:</code><code class=\"string\">'Gospel, blues and rock rolled into one'</code><code class=\"plain\">});</code></div>\n<div class=\"line\"><code class=\"plain\">playlist.push({disc:</code><code class=\"string\">'Animal Notes'</code><code class=\"plain\">, artist:</code><code class=\"string\">'Crack the Sky'</code><code class=\"plain\">, rating:</code><code class=\"string\">'Obscure but rocking'</code><code class=\"plain\">});</code></div>\n<div class=\"line\"><code class=\"comments\">// etc.</code></div>\n<div class=\"line\"><code class=\"plain\">var db = Ti.Database.open(</code><code class=\"string\">'myDatabase'</code><code class=\"plain\">);</code></div>\n<div class=\"line\"><code class=\"plain\">db.execute(</code><code class=\"string\">'BEGIN'</code><code class=\"plain\">); </code><code class=\"comments\">// begin the transaction</code></div>\n<div class=\"line\"><code class=\"keyword\">for</code><code class=\"plain\">(var i=</code><code class=\"value\">0</code><code class=\"plain\">, var j=playlist.length; i &lt; j; i++) {</code></div>\n<div class=\"line\"><code class=\"plain\">\tvar item = playlist[i];</code></div>\n<div class=\"line\"><code class=\"plain\">\tdb.execute(</code><code class=\"string\">'INSERT INTO albums (disc, artist, rating) VALUES (?, ?, ?)'</code><code class=\"plain\">, item.disc, item.artist, item.comment);</code></div>\n<div class=\"line\"><code class=\"plain\">}</code></div>\n<div class=\"line\"><code class=\"plain\">db.execute(</code><code class=\"string\">'COMMIT'</code><code class=\"plain\">);</code></div>\n<div class=\"line\"><code class=\"plain\">db.close();</code></div>\n</div>\n</div> </div>\n<div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-Useaminimalpre-populateddatabase\">\n<h4 class=\"heading \"><span>Use a minimal pre-populated database</span></h4>\n<p>\nShipping a pre-populated database with your app increases the size of the app's package file (ipa or apk) making for slower downloads from the App Store or Market. It also consumes more storage space on the user's device. Because the <tt class=\" \">Resources</tt> directory is read-only on the device, the distribution database file cannot be deleted, resulting in two copies of this file on the user's device.    </p>\n<p>\nRather than shipping a large pre-populated database, you can ship a &quot;skeleton&quot; database file instead. This would be a database with the minimum amount of data required for the application to run. Then, on first boot, ask the user's authorization to download a replacement from a remote source, using something like the following method:    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"plain\">var updateMyDatabase = function(newdata) {</code></div>\n<div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// logic here to delete existing content and insert new data</code></div>\n<div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// maybe you've retrieved a bunch of JSON encoded data that you</code></div>\n<div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// rehydrate, loop through, and insert into your tables</code></div>\n<div class=\"line\"><code class=\"plain\">}</code></div>\n<div class=\"line\"><code class=\"plain\">buttonInstallRemote.addEventListener(</code><code class=\"string\">'click'</code><code class=\"plain\">, function(){</code></div>\n<div class=\"line\"><code class=\"plain\">  var c = Ti.Network.createHTTPClient();</code></div>\n<div class=\"line\"><code class=\"plain\">  c.setTimeout(</code><code class=\"value\">10000</code><code class=\"plain\">);</code></div>\n<div class=\"line\"><code class=\"plain\">  c.onload = function(e){</code></div>\n<div class=\"line\"><code class=\"plain\">    updateMyDatabase(</code><code class=\"keyword\">this</code><code class=\"plain\">.responseData);</code></div>\n<div class=\"line\"><code class=\"plain\">    Ti.UI.createAlertDialog({title:</code><code class=\"string\">'Info'</code><code class=\"plain\">, message:</code><code class=\"string\">'Database installed'</code><code class=\"plain\">, buttonNames: [</code><code class=\"string\">'OK'</code><code class=\"plain\">]}).show();</code></div>\n<div class=\"line\"><code class=\"plain\">  };</code></div>\n<div class=\"line\"><code class=\"plain\">  c.onerror = function(e){</code></div>\n<div class=\"line\"><code class=\"plain\">    Ti.UI.createAlertDialog({title:</code><code class=\"string\">'Error'</code><code class=\"plain\">, message:</code><code class=\"string\">'Error: '</code><code class=\"plain\"> + e.error, buttonNames: [</code><code class=\"string\">'OK'</code><code class=\"plain\">]}).show();</code></div>\n<div class=\"line\"><code class=\"plain\">  };</code></div>\n<div class=\"line\"><code class=\"plain\">  c.open(</code><code class=\"string\">'GET'</code><code class=\"plain\">,\"http:</code><code class=\"comments\">//example.com/getNewDatabaseData);</code></div>\n<div class=\"line\"><code class=\"plain\">  c.send();</code></div>\n<div class=\"line\"><code class=\"plain\">});</code></div>\n</div>\n</div> </div>\n<div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-Storeaversionnumbertoeasedatabaseupdates\">\n<h4 class=\"heading \"><span>Store a version number to ease database updates</span></h4>\n<p>\nBy storing a version number within your database, you can detect which version is installed and take action as needed. For example, your app might determine that version 1.0 of your database is installed, then create new tables or alter existing tables. However, if you don't have a version identifier in your database, you'll be left guessing...is the user really running the old version or did a previous update fail? Are they downloading a new app version or upgrading an existing version? Whatever the scenario, we recommend you include a &quot;version&quot; table in your database in which you store a database version number.    </p>\n<p>\nIf you've failed to do this, you might be able to use a PRAGMA command like the following to detect if a certain column is present and by doing so differentiate between an old and new version of your database.    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"comments\">// ADD COLUMN TO A TABLE</code></div>\n<div class=\"line\"><code class=\"plain\">var addColumn = function(dbname, tblName, newFieldName, colSpec) {</code></div>\n<div class=\"line\"><code class=\"plain\">\tvar db = Ti.Database.open(dbname);</code></div>\n<div class=\"line\"><code class=\"plain\">\tvar fieldExists = </code><code class=\"keyword\">false</code><code class=\"plain\">;</code></div>\n<div class=\"line\"><code class=\"plain\">\tresultSet = db.execute(</code><code class=\"string\">'PRAGMA TABLE_INFO('</code><code class=\"plain\"> + tblName + </code><code class=\"string\">')'</code><code class=\"plain\">);</code></div>\n<div class=\"line\"><code class=\"plain\"> </code><code class=\"keyword\">while</code><code class=\"plain\"> (resultSet.isValidRow()) {</code></div>\n<div class=\"line\"><code class=\"plain\"> </code><code class=\"keyword\">if</code><code class=\"plain\">(resultSet.field(</code><code class=\"value\">1</code><code class=\"plain\">)==newFieldName) {</code></div>\n<div class=\"line\"><code class=\"plain\">\t\t\tfieldExists = </code><code class=\"keyword\">true</code><code class=\"plain\">;</code></div>\n<div class=\"line\"><code class=\"plain\">\t\t}</code></div>\n<div class=\"line\"><code class=\"plain\">\t\tresultSet.next();</code></div>\n<div class=\"line\"><code class=\"plain\">\t} </code><code class=\"comments\">// end while</code></div>\n<div class=\"line\"><code class=\"plain\"> </code><code class=\"keyword\">if</code><code class=\"plain\">(!fieldExists) {</code></div>\n<div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// field does not exist, so add it</code></div>\n<div class=\"line\"><code class=\"plain\">\t\tdb.execute(</code><code class=\"string\">'ALTER TABLE '</code><code class=\"plain\"> + tblName + </code><code class=\"string\">' ADD COLUMN '</code><code class=\"plain\">+newFieldName + </code><code class=\"string\">' '</code><code class=\"plain\"> + colSpec);</code></div>\n<div class=\"line\"><code class=\"plain\">\t}</code></div>\n<div class=\"line\"><code class=\"plain\">\tdb.close();</code></div>\n<div class=\"line\"><code class=\"plain\">};</code></div>\n</div>\n</div> </div>\n</div>\n<div class=\"section section-3 \" id=\"29004901_WorkingwithaSQLiteDatabase-Hands-onPractice\">\n<h3 class=\"heading \"><span>Hands-on Practice</span></h3>\n<div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-Goal\">\n<h4 class=\"heading \"><span>Goal</span></h4>\n<p>\nIn this activity, you will write an app that will display the contents of a database in a table. The app's output will respect the user's preference for units based on data saved in a <tt class=\" \">Ti.App.Properties</tt> property. When complete, your app should look like the following:         <img src=\"images/download/attachments/29004901/Screen_shot_2011-08-16_at_9.32.25_AM.png\" alt=\"images/download/attachments/29004901/Screen_shot_2011-08-16_at_9.32.25_AM.png\" class=\"confluence-embedded-image image-right\" />\n</p>\n</div>\n<div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-Resources\">\n<h4 class=\"heading \"><span>Resources</span></h4>\n<p>\nTo perform the steps in this activity, you will need the following files:    </p>\n<ul class=\" \"><li class=\" \"> <p>\nThe <a class=\"external-link external-link\" href=\"http://assets.appcelerator.com.s3.amazonaws.com/app_u/ebook/weather.sqlite\" target=\"_blank\">sample database, weather.sqlite</a>.    </p>\n</li><li class=\" \"> <p>\n<a class=\"external-link external-link\" href=\"http://assets.appcelerator.com.s3.amazonaws.com/app_u/ebook/5.2_localdata.zip\" target=\"_blank\">5.2 Lab Code, finished state</a> </p>\n</li></ul> </div>\n<div class=\"section section-4 \" id=\"29004901_WorkingwithaSQLiteDatabase-Steps\">\n<h4 class=\"heading \"><span>Steps</span></h4>\n<ol class=\" \"><li class=\" \"> <p>\nIf you didn't complete the 5.2 lab, download the starting code sample and import that project.    </p>\n</li><li class=\" \"> <p>\nDownload the sample database and store it in the Resources directory of your project.    </p>\n</li><li class=\" \"> <p>\nAdd the code to install the database, naming your app's database <tt class=\" \">weather</tt>.    </p>\n</li><li class=\" \"> <p>\nAdd the following function to convert temperatures to Fahrenheit based on the user's preference (update as necessary to reflect your app's namespace):    </p>\n<div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"confbox programlisting scroll-unprocessed\">\n<div class=\"defaultnew syntaxhighlighter\">\n<div class=\"line\"><code class=\"plain\">myapp.convertTemp = function(temp) {</code></div>\n<div class=\"line\"><code class=\"plain\"> </code><code class=\"keyword\">if</code><code class=\"plain\">(Ti.App.Properties.getString(</code><code class=\"string\">'units'</code><code class=\"plain\">,</code><code class=\"string\">'c'</code><code class=\"plain\">)===</code><code class=\"string\">'f'</code><code class=\"plain\">) {</code></div>\n<div class=\"line\"><code class=\"plain\"> </code><code class=\"keyword\">return</code><code class=\"plain\"> Math.round(temp*</code><code class=\"value\">1.8</code><code class=\"plain\">+</code><code class=\"value\">32</code><code class=\"plain\">) +</code><code class=\"string\">'\\u00b0F'</code><code class=\"plain\">; </code><code class=\"comments\">// convert to Fahrenheit &amp; append degree symbol-F</code></div>\n<div class=\"line\"><code class=\"plain\">\t} </code><code class=\"keyword\">else</code><code class=\"plain\"> {</code></div>\n<div class=\"line\"><code class=\"plain\"> </code><code class=\"keyword\">return</code><code class=\"plain\"> temp +</code><code class=\"string\">'\\u00b0C'</code><code class=\"plain\">;</code></div>\n<div class=\"line\"><code class=\"plain\">\t}</code></div>\n<div class=\"line\"><code class=\"plain\">};</code></div>\n</div>\n</div></li><li class=\" \"> <p>\nWrite a function named <tt class=\" \">getRows()</tt> that accomplishes the following:    </p>\n<ul class=\" \"><li class=\" \"> <p>\nOpens the database    </p>\n</li><li class=\" \"> <p>\nExecutes the following query: <tt class=\" \">SELECT city, temp, condition, icon FROM cities JOIN conditionCodes ON cities.conditionID = conditionCodes.conditionID ORDER BY city</tt> </p>\n</li><li class=\" \"> <p>\nLoop through the result set. For each result, create a table row that contains these three child views:    </p>\n<ul class=\" \"><li class=\" \"> <p>\nAn ImageView pointing to <a class=\"external-link external-link\" href=\"http://www.worldweather.org/img_cartoon/\" target=\"_blank\">http://www.worldweather.org/img_cartoon/</a> plus the value of the icon column. The image should be shown at the left edge of the row.    </p>\n</li><li class=\" \"> <p>\nLabel to display the City name. The text should be large and bold, and positioned to the right of the image.    </p>\n</li><li class=\" \"> <p>\nA Label to display the temperature, as formatted by the <tt class=\" \">convertTemp()</tt> function. It should be smaller text, positioned at the right edge of the row.    </p>\n</li></ul></li><li class=\" \"> <p>\nMake sure to close the database connection when the function is done, and return the resulting array to the caller.    </p>\n</li></ul></li><li class=\" \"> <p>\nIn the window on tab 1, add a TableView. Then write a <tt class=\" \">populate()</tt> function that sets the table's data to the results from the <tt class=\" \">getRows()</tt> function.    </p>\n</li><li class=\" \"> <p>\nAdd an App-level event listener that calls the <tt class=\" \">populate()</tt> function.    </p>\n</li><li class=\" \"> <p>\nUpdate the event listener on the units switch (on the preferences tab) to fire your app-level event when the user updates the temperature units.    </p>\n</li><li class=\" \"> <p>\nBuild and test your app in the simulator/emulator.    </p>\n</li></ol> </div>\n</div>\n<div class=\"section section-3 \" id=\"29004901_WorkingwithaSQLiteDatabase-ReferencesandFurtherReading\">\n<h3 class=\"heading \"><span>References and Further Reading</span></h3>\n<ul class=\" \"><li class=\" \"> <p>\n<a class=\"external-link external-link\" href=\"#!/api/Titanium.Database\">API docs: Ti.Database</a> </p>\n</li><li class=\" \"> <p>\nthe <a class=\"external-link external-link\" href=\"http://www.sqlite.org/\" target=\"_blank\">SQLite Official Homepage</a> </p>\n</li><li class=\" \"> <p>\n<a class=\"external-link external-link\" href=\"http://www.sqlite.org/different.html\" target=\"_blank\">Distinctive Features of SQLite</a> </p>\n</li><li class=\" \"> <p>\nthe <a class=\"external-link external-link\" href=\"http://www.sqlite.org/sqlite.html\" target=\"_blank\">SQLite Official Getting Started</a> guide    </p>\n</li><li class=\" \"> <p>\n<a class=\"external-link external-link\" href=\"http://assets.appcelerator.com.s3.amazonaws.com/app_u/ebook/5.3_localdata.zip\" target=\"_blank\">Finished code</a> </p>\n</li></ul> </div>\n</div>\n<div class=\"section section-2 \" id=\"29004901_WorkingwithaSQLiteDatabase-Summary\">\n<h2 class=\"heading \"><span>Summary</span></h2>\n<p>\nIn this chapter, you learned how to interact with the built-in SQLite3 RDMS with the <tt class=\" \">Ti.Database</tt> module. You learned how to create, install, and populate databases. You also learned how to use SQL to perform CRUD (create, read, update, and delete) operations on your data.    </p>\n</div>\n</div>\n<div class=\"footer\">\n            Created with <a href=\"http://k15t.com/display/web/Scroll-Wiki-EclipseHelp-Exporter-for-Confluence\" target=\"_blank\">Scroll EclipseHelp Exporter for Confluence</a>.\n        </div>\n</div>\n</body>\n</html>\n","title":"Working with a SQLite Database"});