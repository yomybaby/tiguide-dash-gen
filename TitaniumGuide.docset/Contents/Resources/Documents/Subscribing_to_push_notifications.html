<!-- single file version -->
<!DOCTYPE html>
<html>
<head>
  <link href="css/github.css" rel="stylesheet" type="text/css">
  <link href="resources/css/common.css" rel="stylesheet" type="text/css">
  <meta charset="utf-8" />
</head>
<body>

<div class="container">
<div class="header"></div>
<div id="37551717" class="content">
<h1>Subscribing to push notifications</h1>
<p>
<span style="color: #484848;">
For a push notification to reach a user, the user (or device) must be subscribed to receive push notifications on one or more notification <i class=" ">channels</i>. The application must also obtain a <i class=" ">device token</i>, which permits ACS to communicate with the push service provider (Google Cloud Messaging or Apple Push Notification). This guide explains how to     <span style="color: #484848;">
how obtain a device token, and how to     </span>
use the <a class="external-link external-link" href="/platform/latest/#!/api/Titanium.Cloud.PushNotifications">PushNotifications API</a> to manage your user&apos;s notification subscriptions.     </span>
</p>
<p>
<span style="color: #484848;">
</span>
</p>
<ul class="toc-indentation "><li class=" "> <p>
<a class="document-link " href="#!/guide/Subscribing_to_push_notifications-section-37551717_Subscribingtopushnotifications-Obtainingadevicetoken" subscribing_to_push_notifications.html#37551717_subscribingtopushnotifications-obtainingadevicetoken="Subscribing_to_push_notifications.html#37551717_Subscribingtopushnotifications-Obtainingadevicetoken">Obtaining a device token</a> </p>
<ul class="toc-indentation "><li class=" "> <p>
<a class="document-link " href="#!/guide/Subscribing_to_push_notifications-section-37551717_Subscribingtopushnotifications-ObtainingadevicetokenonAndroid" subscribing_to_push_notifications.html#37551717_subscribingtopushnotifications-obtainingadevicetokenonandroid="Subscribing_to_push_notifications.html#37551717_Subscribingtopushnotifications-ObtainingadevicetokenonAndroid">Obtaining a device token on Android</a> </p>
</li><li class=" "> <p>
<a class="document-link " href="#!/guide/Subscribing_to_push_notifications-section-37551717_Subscribingtopushnotifications-ObtainingadevicetokenoniOS" subscribing_to_push_notifications.html#37551717_subscribingtopushnotifications-obtainingadevicetokenonios="Subscribing_to_push_notifications.html#37551717_Subscribingtopushnotifications-ObtainingadevicetokenoniOS">Obtaining a device token on iOS</a> </p>
</li></ul></li><li class=" "> <p>
<a class="document-link " href="#!/guide/Subscribing_to_push_notifications-section-37551717_Subscribingtopushnotifications-UsingtheTitaniumPushNotificationsAPI" subscribing_to_push_notifications.html#37551717_subscribingtopushnotifications-usingthetitaniumpushnotificationsapi="Subscribing_to_push_notifications.html#37551717_Subscribingtopushnotifications-UsingtheTitaniumPushNotificationsAPI">Using the Titanium PushNotifications API</a> </p>
<ul class="toc-indentation "><li class=" "> <p>
<a class="document-link " href="#!/guide/Subscribing_to_push_notifications-section-37551717_Subscribingtopushnotifications-AddingtheCloudmoduletoyourproject" subscribing_to_push_notifications.html#37551717_subscribingtopushnotifications-addingthecloudmoduletoyourproject="Subscribing_to_push_notifications.html#37551717_Subscribingtopushnotifications-AddingtheCloudmoduletoyourproject">Adding the Cloud module to your project</a> </p>
</li><li class=" "> <p>
<a class="document-link " href="#!/guide/Subscribing_to_push_notifications-section-37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithDeviceTokens" subscribing_to_push_notifications.html#37551717_subscribingtopushnotifications-subscribingtopushnotificationswithdevicetokens="Subscribing_to_push_notifications.html#37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithDeviceTokens">Subscribing to Push Notifications with Device Tokens</a> </p>
</li><li class=" "> <p>
<a class="document-link " href="#!/guide/Subscribing_to_push_notifications-section-37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithUserSessions" subscribing_to_push_notifications.html#37551717_subscribingtopushnotifications-subscribingtopushnotificationswithusersessions="Subscribing_to_push_notifications.html#37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithUserSessions">Subscribing to Push Notifications with User Sessions</a> </p>
</li><li class=" "> <p>
<a class="document-link " href="#!/guide/Subscribing_to_push_notifications-section-37551717_Subscribingtopushnotifications-UpdatingSubscriptionswithDeviceLocation" subscribing_to_push_notifications.html#37551717_subscribingtopushnotifications-updatingsubscriptionswithdevicelocation="Subscribing_to_push_notifications.html#37551717_Subscribingtopushnotifications-UpdatingSubscriptionswithDeviceLocation">Updating Subscriptions with Device Location</a> </p>
</li></ul></li><li class=" "> <p>
<a class="document-link " href="#!/guide/Subscribing_to_push_notifications-section-37551717_Subscribingtopushnotifications-Parsinganotificationpayload" subscribing_to_push_notifications.html#37551717_subscribingtopushnotifications-parsinganotificationpayload="Subscribing_to_push_notifications.html#37551717_Subscribingtopushnotifications-Parsinganotificationpayload">Parsing a notification payload</a> </p>
</li><li class=" "> <p>
<a class="document-link " href="#!/guide/Subscribing_to_push_notifications-section-37551717_Subscribingtopushnotifications-Moreexamples" subscribing_to_push_notifications.html#37551717_subscribingtopushnotifications-moreexamples="Subscribing_to_push_notifications.html#37551717_Subscribingtopushnotifications-Moreexamples">More examples</a> </p>
</li></ul> <p>
</p>
<div class="section section-2 " id="37551717_Subscribingtopushnotifications-Obtainingadevicetoken">
<h2 class="heading "><span>Obtaining a device token</span></h2>
<p>
To receive push notifications, your application first needs to obtain a <i class=" ">device token</i>. To obtain a device token:    </p>
<ul class=" "><li class=" "> <p>
On Android, call the <a class="external-link external-link" href="#!/api/Titanium.CloudPush">Titanium.CloudPush</a> module&apos;s <tt class=" ">retrieveDeviceToken()</tt> method.    </p>
</li><li class=" "> <p>
On iOS, call the <tt class=" ">Titanium.Network.registerForPushNotifications()</tt> </p>
</li></ul> <p>
Once your application has obtained a device token it should save it for later use.    </p>
<div class="section section-3 " id="37551717_Subscribingtopushnotifications-ObtainingadevicetokenonAndroid">
<h3 class="heading "><span>Obtaining a device token on Android</span></h3>
<p>
To obtain a device token from GCM you first need to add the CloudPush module to your project. This module is included with the Titanium SDK, but is not included by default in new projects.    </p>
<p>
<strong class=" ">To add the CloudPush module to your project</strong>:    </p>
<ol class=" "><li class=" "> <p>
In Studio, open your project&apos;s <tt class=" ">tiapp.xml</tt> file.    </p>
</li><li class=" "> <p>
In the <strong class=" ">Modules</strong> section, click the add (<strong class=" ">+</strong>) button.    </p>
</li><li class=" "> <p>
Select <strong class=" ">ti.cloudpush</strong> and click <strong class=" ">OK</strong>.    </p>
</li></ol> <p>
In your application code, require the <tt class=" ">ti.cloudpush</tt> module and call its <tt class=" ">retrieveDeviceToken()</tt> <span style="color: #484848;">
method, and register event handlers to respond to <tt class=" ">success</tt> and <tt class=" ">error</tt> events.     </span>
Once a device token has been retrieved, your application can listen for the <tt class=" ">callback</tt> event to process incoming push notifications. Your application should save the device token for later use. The following code demonstrates the minimal code required to obtain a device token and setup event handlers:    </p>
<div xmlns="http://www.w3.org/1999/xhtml" class="confbox programlisting scroll-unprocessed">
<div class="defaultnew syntaxhighlighter">
<div class="line"><code class="comments">// Require the module</code></div>
<div class="line"><code class="plain">var CloudPush = require(</code><code class="string">&apos;ti.cloudpush&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">var deviceToken = </code><code class="keyword">null</code><code class="plain">;</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="comments">// Initialize the module</code></div>
<div class="line"><code class="plain">CloudPush.retrieveDeviceToken({</code></div>
<div class="line"><code class="plain">    success: deviceTokenSuccess,</code></div>
<div class="line"><code class="plain">    error: deviceTokenError</code></div>
<div class="line"><code class="plain">});</code></div>
<div class="line"><code class="comments">// Enable push notifications for this device</code></div>
<div class="line"><code class="comments">// Save the device token for subsequent API calls</code></div>
<div class="line"><code class="plain">function deviceTokenSuccess(e) {</code></div>
<div class="line"><code class="plain">    deviceToken = e.deviceToken;</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">function deviceTokenError(e) {</code></div>
<div class="line"><code class="plain">    alert(</code><code class="string">&apos;Failed to register for push notifications! &apos;</code><code class="plain"> + e.error);</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="comments">// Process incoming push notifications</code></div>
<div class="line"><code class="plain">CloudPush.addEventListener(</code><code class="string">&apos;callback&apos;</code><code class="plain">, function (evt) {</code></div>
<div class="line"><code class="plain">    alert(</code><code class="string">&quot;Notification received: &quot;</code><code class="plain"> + evt.payload);</code></div>
<div class="line"><code class="plain">});</code></div>
</div>
</div> </div>
<div class="section section-3 " id="37551717_Subscribingtopushnotifications-ObtainingadevicetokenoniOS">
<h3 class="heading "><span>Obtaining a device token on iOS</span></h3>
<p>
To obtain a device token on iOS, call the <tt class=" ">Titanium.Network.registerForPushNotifications()</tt> and setup callbacks for the <tt class=" ">success</tt>, <tt class=" ">error</tt>, and <tt class=" ">callback</tt> events. You can also specify the types of notifications enabled for your application, which can include one or more of the following: <a class="external-link external-link" href="#!/api/Titanium.Network-property-NOTIFICATION_TYPE_ALERT">NOTIFICATION_TYPE_ALERT</a>, <a class="external-link external-link" href="#!/api/Titanium.Network-property-NOTIFICATION_TYPE_BADGE">NOTIFICATION_TYPE_BADGE</a>, <a class="external-link external-link" href="#!/api/Titanium.Network-property-NOTIFICATION_TYPE_NEWSSTAND">NOTIFICATION_TYPE_NEWSSTAND</a>, or <a class="external-link external-link" href="#!/api/Titanium.Network-property-NOTIFICATION_TYPE_SOUND">NOTIFICATION_TYPE_SOUND</a>.    </p>
<p>
For iOS 8 and later, you need to register the user notification types you want to use with the <tt class=" ">Titanium.App.iOS.registerUserNotificationSettings()</tt> method before calling the <tt class=" ">registerForPushNotifications()</tt> method.  Passing the notification types to use with the <tt class=" ">registerForPushNotifications()</tt> method has no effect on devices running iOS 8 or later.    </p>
<div xmlns="http://www.w3.org/1999/xhtml" class="confbox programlisting scroll-unprocessed">
<div class="defaultnew syntaxhighlighter">
<div class="line"><code class="plain">var deviceToken = </code><code class="keyword">null</code><code class="plain">;</code></div>
<div class="line"><code class="comments">// Check if the device is running iOS 8 or later</code></div>
<div class="line"><code class="keyword">if</code><code class="plain"> (Ti.Platform.name == </code><code class="string">&quot;iPhone OS&quot;</code><code class="plain"> &amp;&amp; parseInt(Ti.Platform.version.split(</code><code class="string">&quot;.&quot;</code><code class="plain">)[</code><code class="value">0</code><code class="plain">]) &gt;= </code><code class="value">8</code><code class="plain">) {</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="plain"> </code><code class="comments">// Wait for user settings to be registered before registering for push notifications</code></div>
<div class="line"><code class="plain">    Ti.App.iOS.addEventListener(</code><code class="string">&apos;usernotificationsettings&apos;</code><code class="plain">, function registerForPush() {</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="plain"> </code><code class="comments">// Remove event listener once registered for push notifications</code></div>
<div class="line"><code class="plain">        Ti.App.iOS.removeEventListener(</code><code class="string">&apos;usernotificationsettings&apos;</code><code class="plain">, registerForPush);&#xA0;</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="plain">        Ti.Network.registerForPushNotifications({</code></div>
<div class="line"><code class="plain">            success: deviceTokenSuccess,</code></div>
<div class="line"><code class="plain">            error: deviceTokenError,</code></div>
<div class="line"><code class="plain">            callback: receivePush</code></div>
<div class="line"><code class="plain">        });</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="plain"> </code><code class="comments">// Register notification types to use</code></div>
<div class="line"><code class="plain">    Ti.App.iOS.registerUserNotificationSettings({</code></div>
<div class="line"><code class="plain">	    types: [</code></div>
<div class="line"><code class="plain">            Ti.App.iOS.USER_NOTIFICATION_TYPE_ALERT,</code></div>
<div class="line"><code class="plain">            Ti.App.iOS.USER_NOTIFICATION_TYPE_SOUND,</code></div>
<div class="line"><code class="plain">            Ti.App.iOS.USER_NOTIFICATION_TYPE_BADGE</code></div>
<div class="line"><code class="plain">        ]</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="comments">// For iOS 7 and earlier</code></div>
<div class="line"><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">    Ti.Network.registerForPushNotifications({</code></div>
<div class="line"><code class="plain"> </code><code class="comments">// Specifies which notifications to receive</code></div>
<div class="line"><code class="plain">        types: [</code></div>
<div class="line"><code class="plain">            Ti.Network.NOTIFICATION_TYPE_BADGE,</code></div>
<div class="line"><code class="plain">            Ti.Network.NOTIFICATION_TYPE_ALERT,</code></div>
<div class="line"><code class="plain">            Ti.Network.NOTIFICATION_TYPE_SOUND</code></div>
<div class="line"><code class="plain">        ],</code></div>
<div class="line"><code class="plain">        success: deviceTokenSuccess,</code></div>
<div class="line"><code class="plain">        error: deviceTokenError,</code></div>
<div class="line"><code class="plain">        callback: receivePush</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="comments">// Process incoming push notifications</code></div>
<div class="line"><code class="plain">function receivePush(e) {</code></div>
<div class="line"><code class="plain">    alert(</code><code class="string">&apos;Received push: &apos;</code><code class="plain"> + JSON.stringify(e));</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="comments">// Save the device token for subsequent API calls</code></div>
<div class="line"><code class="plain">function deviceTokenSuccess(e) {</code></div>
<div class="line"><code class="plain">    deviceToken = e.deviceToken;</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">function deviceTokenError(e) {</code></div>
<div class="line"><code class="plain">    alert(</code><code class="string">&apos;Failed to register for push notifications! &apos;</code><code class="plain"> + e.error);</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
</div> </div>
</div>
<div class="section section-2 " id="37551717_Subscribingtopushnotifications-UsingtheTitaniumPushNotificationsAPI">
<h2 class="heading "><span>Using the Titanium PushNotifications API</span></h2>
<p>
Once your application has <a class="document-link " href="#!/guide/Subscribing_to_push_notifications-section-37551717_Subscribingtopushnotifications-Obtainingadevicetoken" subscribing_to_push_notifications.html#37551717_subscribingtopushnotifications-obtainingadevicetoken="Subscribing_to_push_notifications.html#37551717_Subscribingtopushnotifications-Obtainingadevicetoken">obtained a device token</a> and setup <tt class=" ">callback</tt> event handlers, you can use the <a class="external-link external-link" href="#!/api/Titanium.Cloud.PushNotifications">Titanium.Cloud.PushNotifications</a> APIs to manage the user&apos;s notification subscriptions. You use the PushNotifications API to subscribe and unsubscribe to notifications <i class=" ">channels</i>, send notifications to other ACS users or devices, or query ACS for the current user&apos;s subscriptions.    </p>
<p>
<span style="color: #000000;">
Session- and token-based subscriptions    </span>
</p>
<p>
ACS provides two ways for an application to manage its push notification subscriptions: <strong class=" ">session-based</strong> and <strong class=" ">token-based. </strong> <span style="color: #484848;">
Session-based subscriptions require that the current user be     </span>
<a class="external-link external-link" href="/cloud/latest/#!/api/Users-method-login">logged in</a> <span style="color: #484848;">
 to ACS to subscribe/unsubscribe, send, or receive push notifications.     </span>
Token-based notifications only     <span style="color: #484848;">
require the application to retrieve a device token (see     </span>
<a class="document-link " href="#!/guide/Subscribing_to_push_notifications-section-37551717_Subscribingtopushnotifications-Obtainingadevicetoken" subscribing_to_push_notifications.html#37551717_subscribingtopushnotifications-obtainingadevicetoken="Subscribing_to_push_notifications.html#37551717_Subscribingtopushnotifications-Obtainingadevicetoken">Obtaining a device token</a> <span style="color: #484848;">
).    </span>
</p>
<p>
The <a class="external-link external-link" href="#!/api/Titanium.Cloud.PushNotifications-method-subscribe">Cloud.PushNotifications</a> API provides equivalent methods for using either of these approaches. For instance, you call the <tt class=" ">subscribe()</tt> method to subscribe the currently logged in ACS user to a channel, or <tt class=" ">subscribeToken()</tt> to subscribe an application user with only the obtained token. Similarly, there are equivalent methods for unsubscribing from a channel <tt class=" ">(unsubscribe()</tt> and <tt class=" ">unsubscribeToken()</tt>) and sending notifications <tt class=" ">(notify()</tt> and <tt class=" ">notifyToken()</tt>).    </p>
<div class="confbox admonition admonition-note aui-message warning shadowed information-macro">
<p>
It&apos;s recommended that you use either session- or token-based subscriptions in your application, but not both together.    </p>
</div>
<div class="section section-3 " id="37551717_Subscribingtopushnotifications-AddingtheCloudmoduletoyourproject">
<h3 class="heading "><span>Adding the Cloud module to your project</span></h3>
<p>
The Cloud module is included with the Titanium SDK, but is not enabled by default in new projects.    </p>
<p>
<strong class=" ">To add the Cloud module to your project</strong>:    </p>
<ol class=" "><li class=" "> <p>
Open your project&apos;s <tt class=" ">tiapp.xml</tt> file.    </p>
</li><li class=" "> <p>
In the <strong class=" ">Modules</strong> section, click the Add button (green plus sign).    </p>
</li><li class=" "> <p>
Select <strong class=" ">ti.cloud</strong> and click <strong class=" ">OK</strong><strong class=" ">.</strong> </p>
</li></ol> </div>
<div class="section section-3 " id="37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithDeviceTokens">
<h3 class="heading "><span>Subscribing to Push Notifications with Device Tokens</span></h3>
<p>
To subscribe your application to receive push notifications using only a device the token, you call the <tt class=" ">subscribeToken()</tt> method. In the following sample code, the user is subscribed to the &quot;news_alerts&quot; channel when tap the Subscribe button; tapping the Unsubscribe button calls the <tt class=" ">unsubscribeToken()</tt> method.    </p>
<p>
The following example is functionally identical to the <a class="document-link " href="#!/guide/Subscribing_to_push_notifications-section-37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithUserSessions" subscribing_to_push_notifications.html#37551717_subscribingtopushnotifications-subscribingtopushnotificationswithusersessions="Subscribing_to_push_notifications.html#37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithUserSessions">token-based version</a>, except that it includes functionality to log the user into ACS.    </p>
<div xmlns="http://www.w3.org/1999/xhtml" class="confbox programlisting scroll-unprocessed">
<div class="defaultnew syntaxhighlighter">
<div class="line"><code class="comments">// You first need to get a device token (see previous section):</code></div>
<div class="line"><code class="plain">var deviceToken;</code></div>
<div class="line"><code class="comments">// Require the Cloud module</code></div>
<div class="line"><code class="plain">var Cloud = require(</code><code class="string">&quot;ti.cloud&quot;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">function subscribeToChannel () {</code></div>
<div class="line"><code class="plain"> </code><code class="comments">// Subscribes the device to the &apos;news_alerts&apos; channel</code></div>
<div class="line"><code class="plain"> </code><code class="comments">// Specify the push type as either &apos;android&apos; for Android or &apos;ios&apos; for iOS</code></div>
<div class="line"><code class="plain">    Cloud.PushNotifications.subscribeToken({</code></div>
<div class="line"><code class="plain">        device_token: deviceToken,</code></div>
<div class="line"><code class="plain">        channel: </code><code class="string">&apos;news_alerts&apos;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        type: Ti.Platform.name == </code><code class="string">&apos;android&apos;</code><code class="plain"> ? </code><code class="string">&apos;android&apos;</code><code class="plain"> : </code><code class="string">&apos;ios&apos;</code></div>
<div class="line"><code class="plain">    }, function (e) {</code></div>
<div class="line"><code class="plain"> </code><code class="keyword">if</code><code class="plain"> (e.success) {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Subscribed&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        } </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Error:\n&apos;</code><code class="plain"> + ((e.error &amp;&amp; e.message) || JSON.stringify(e)));</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">function unsubscribeToChannel () {</code></div>
<div class="line"><code class="plain"> </code><code class="comments">// Unsubscribes the device from the &apos;test&apos; channel</code></div>
<div class="line"><code class="plain">    Cloud.PushNotifications.unsubscribeToken({</code></div>
<div class="line"><code class="plain">        device_token: deviceToken,</code></div>
<div class="line"><code class="plain">        channel: </code><code class="string">&apos;news_alerts&apos;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    }, function (e) {</code></div>
<div class="line"><code class="plain"> </code><code class="keyword">if</code><code class="plain"> (e.success) {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Unsubscribed&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        } </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Error:\n&apos;</code><code class="plain"> + ((e.error &amp;&amp; e.message) || JSON.stringify(e)));</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="plain">var win = Ti.UI.createWindow({</code></div>
<div class="line"><code class="plain">    backgroundColor: </code><code class="string">&apos;white&apos;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    layout:</code><code class="string">&apos;vertical&apos;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    exitOnClose: </code><code class="keyword">true</code></div>
<div class="line"><code class="plain">});</code></div>
<div class="line"><code class="plain">var subscribe = Ti.UI.createButton({title:</code><code class="string">&apos;Subscribe&apos;</code><code class="plain">});</code></div>
<div class="line"><code class="plain">subscribe.addEventListener(</code><code class="string">&apos;click&apos;</code><code class="plain">, subscribeToChannel);</code></div>
<div class="line"><code class="plain">win.add(subscribe);</code></div>
<div class="line"><code class="plain">var unsubscribe = Ti.UI.createButton({title:</code><code class="string">&apos;Unsubscribe&apos;</code><code class="plain">});</code></div>
<div class="line"><code class="plain">unsubscribe.addEventListener(</code><code class="string">&apos;click&apos;</code><code class="plain">, unsubscribeToChannel);</code></div>
<div class="line"><code class="plain">win.add(unsubscribe);</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="plain">win.open();</code></div>
</div>
</div> </div>
<div class="section section-3 " id="37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithUserSessions">
<h3 class="heading "><span>Subscribing to Push Notifications with User Sessions</span></h3>
<p>
You can subscribe to receive push notifications based the user&apos;s current ACS session. If you do not require push notifications to be sent to specific users, then consider using <a class="document-link " href="#!/guide/Subscribing_to_push_notifications-section-37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithDeviceTokens" subscribing_to_push_notifications.html#37551717_subscribingtopushnotifications-subscribingtopushnotificationswithdevicetokens="Subscribing_to_push_notifications.html#37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithDeviceTokens">token-based notifications</a>. You can <a class="external-link external-link" href="/platform/latest/#!/guide/Managing_Users">create an ACS user</a> in Appcelerator Dashboard or programmatically (as shown in the <a class="external-link external-link" href="#!/api/Titanium.Cloud.Users">example</a> for <a class="external-link external-link" href="#!/api/Titanium.Cloud.Users">Titanium.Cloud.Users</a>).    </p>
<p>
The following example is functionally identical to the <a class="document-link " href="#!/guide/Subscribing_to_push_notifications-section-37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithDeviceTokens" subscribing_to_push_notifications.html#37551717_subscribingtopushnotifications-subscribingtopushnotificationswithdevicetokens="Subscribing_to_push_notifications.html#37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithDeviceTokens">token-based version</a>, except that it includes functionality to log the user into ACS.    </p>
<div xmlns="http://www.w3.org/1999/xhtml" class="confbox programlisting scroll-unprocessed">
<div class="defaultnew syntaxhighlighter">
<div class="line"><code class="comments">// For this example to work, you need to get the device token. See the previous section.</code></div>
<div class="line"><code class="comments">// You also need an ACS user account.</code></div>
<div class="line"><code class="comments">// Require in the Cloud module</code></div>
<div class="line"><code class="plain">var Cloud = require(</code><code class="string">&quot;ti.cloud&quot;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="plain">function loginUser(){</code></div>
<div class="line"><code class="plain"> </code><code class="comments">// Log in to ACS</code></div>
<div class="line"><code class="plain">    Cloud.Users.login({</code></div>
<div class="line"><code class="plain">        login: </code><code class="string">&apos;waldo&apos;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        password: </code><code class="string">&apos;password&apos;</code></div>
<div class="line"><code class="plain">    }, function (e) {</code></div>
<div class="line"><code class="plain"> </code><code class="keyword">if</code><code class="plain"> (e.success) {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Login successful&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        } </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Error:\n&apos;</code><code class="plain"> +</code></div>
<div class="line"><code class="plain">                ((e.error &amp;&amp; e.message) || JSON.stringify(e)));</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">function subscribeToChannel(){</code></div>
<div class="line"><code class="plain"> </code><code class="comments">// Subscribe the user and device to the &apos;test&apos; channel</code></div>
<div class="line"><code class="plain"> </code><code class="comments">// Specify the push type as either &apos;android&apos; for Android or &apos;ios&apos; for iOS</code></div>
<div class="line"><code class="plain"> </code><code class="comments">// Check if logged in:</code></div>
<div class="line"><code class="plain">    Cloud.PushNotifications.subscribe({</code></div>
<div class="line"><code class="plain">        channel: </code><code class="string">&apos;test&apos;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        device_token: deviceToken,</code></div>
<div class="line"><code class="plain">        type: Ti.Platform.name == </code><code class="string">&apos;android&apos;</code><code class="plain"> ? </code><code class="string">&apos;android&apos;</code><code class="plain"> : </code><code class="string">&apos;ios&apos;</code></div>
<div class="line"><code class="plain">    }, function (e) {</code></div>
<div class="line"><code class="plain"> </code><code class="keyword">if</code><code class="plain"> (e.success) {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Subscribed&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        } </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Error:\n&apos;</code><code class="plain"> +</code></div>
<div class="line"><code class="plain">                ((e.error &amp;&amp; e.message) || JSON.stringify(e)));</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">function unsubscribeToChannel ()</code></div>
<div class="line"><code class="plain"> </code><code class="comments">// Unsubscribes the user and device from the &apos;test&apos; channel</code></div>
<div class="line"><code class="plain">    Cloud.PushNotifications.unsubscribe({</code></div>
<div class="line"><code class="plain">        channel: </code><code class="string">&apos;test&apos;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        device_token: deviceToken</code></div>
<div class="line"><code class="plain">    }, function (e) {</code></div>
<div class="line"><code class="plain"> </code><code class="keyword">if</code><code class="plain"> (e.success) {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Unsubscribed&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        } </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Error:\n&apos;</code><code class="plain"> +</code></div>
<div class="line"><code class="plain">                ((e.error &amp;&amp; e.message) || JSON.stringify(e)));</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="plain">var win = Ti.UI.createWindow({</code></div>
<div class="line"><code class="plain">    backgroundColor: </code><code class="string">&apos;white&apos;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    layout:</code><code class="string">&apos;vertical&apos;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    exitOnClose: </code><code class="keyword">true</code></div>
<div class="line"><code class="plain">});</code></div>
<div class="line"><code class="plain">var subscribe = Ti.UI.createButton({title:</code><code class="string">&apos;Subscribe&apos;</code><code class="plain">});</code></div>
<div class="line"><code class="plain">subscribe.addEventListener(</code><code class="string">&apos;click&apos;</code><code class="plain">, subscribeToChannel);</code></div>
<div class="line"><code class="plain">win.add(subscribe);</code></div>
<div class="line"><code class="plain">var unsubscribe = Ti.UI.createButton({title:</code><code class="string">&apos;Unsubscribe&apos;</code><code class="plain">});</code></div>
<div class="line"><code class="plain">unsubscribe.addEventListener(</code><code class="string">&apos;click&apos;</code><code class="plain">, unsubscribeToChannel);</code></div>
<div class="line"><code class="plain">win.add(unsubscribe);</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="plain">win.open();</code></div>
<div class="line"><code class="plain">loginUser();</code></div>
</div>
</div> </div>
<div class="section section-3 " id="37551717_Subscribingtopushnotifications-UpdatingSubscriptionswithDeviceLocation">
<h3 class="heading "><span>Updating Subscriptions with Device Location</span></h3>
<p>
Appcelerator Platform users can send push notifications to devices located within a geographic area you specify (see <a class="external-link external-link" href="/platform/latest/#!/guide/Sending_and_Scheduling_Push_Notifications-section-37551726_SendingandSchedulingPushNotifications-Sendinggeo-basedpushnotifications">Sending geo-based push notifications</a>). For a geo-based push to reach its intended recipients, the application must periodically update its location with ACS by calling the <tt class=" ">updateSubscription()</tt> method.    </p>
<p>
To obtain the device&apos;s current location, you call the <tt class=" ">getCurrentPosition()</tt> or registering to listen for <tt class=" ">location</tt> events. Doing this frequently, however, can be a significant drain on the device&apos;s battery. The <a class="external-link external-link" href="/platform/latest/#!/api/Modules.Geofence">Ti.Geofence</a> module (available to Appcelerator Platform users) provides a more battery-efficient way to monitor a device&apos;s movement in to, or out of, virtual geographic perimeters, or <i class=" ">geofences</i>.    </p>
<p>
When the device enters a defined geofence region, the application is notified and can obtain the device&apos;s current location and send it to ACS. The following code demonstrates this approach.    </p>
<div xmlns="http://www.w3.org/1999/xhtml" class="confbox programlisting scroll-unprocessed">
<div class="defaultnew syntaxhighlighter">
<div class="line"><code class="plain">var Cloud = require(</code><code class="string">&apos;ti.cloud&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">var Geofence = require(</code><code class="string">&apos;ti.geofence&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="comments">// Define a region to monitor:</code></div>
<div class="line"><code class="plain">var region1 = Geofence.createRegion({</code></div>
<div class="line"><code class="plain">    center: {</code></div>
<div class="line"><code class="plain">        latitude:</code><code class="value">37.389601</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        longitude:-</code><code class="value">122.050169</code></div>
<div class="line"><code class="plain">    },</code></div>
<div class="line"><code class="plain">    radius:</code><code class="value">500</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    identifier:</code><code class="string">&apos;Appcelerator&apos;</code></div>
<div class="line"><code class="plain">});</code></div>
<div class="line"><code class="comments">// Start monitoring for region entrances/exits:&#xA0;</code></div>
<div class="line"><code class="plain">Geofence.startMonitoringForRegions(region1);</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="comments">// Event listener invoked when device enters a region being monitored: </code></div>
<div class="line"><code class="plain">Geofence.addEventListener(</code><code class="string">&quot;enterregions&quot;</code><code class="plain">, function(e) {</code></div>
<div class="line"><code class="plain"> </code><code class="comments">// Get current location and update subscription with location:</code></div>
<div class="line"><code class="plain">    Titanium.Geolocation.getCurrentPosition(function(e) {</code></div>
<div class="line"><code class="plain"> </code><code class="keyword">if</code><code class="plain"> (e.error) {</code></div>
<div class="line"><code class="plain">    		Ti.API.error(</code><code class="string">&apos;Error: &apos;</code><code class="plain"> + e.error);</code></div>
<div class="line"><code class="plain">    	} </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">    		var latitude = e.coords.latitude;</code></div>
<div class="line"><code class="plain">    		var longitude = e.coords.longitude;</code></div>
<div class="line"><code class="plain">    		Cloud.PushNotifications.updateSubscription({</code></div>
<div class="line"><code class="plain">    			device_token : pushDeviceToken,</code></div>
<div class="line"><code class="plain">    			loc : [longitude, latitude]</code></div>
<div class="line"><code class="plain">    		}, function(e) {</code></div>
<div class="line"><code class="plain"> </code><code class="keyword">if</code><code class="plain"> (e.success) {</code></div>
<div class="line"><code class="plain">    				alert(</code><code class="string">&apos;Subscription Updated.&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">    			} </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">    				alert(e);</code></div>
<div class="line"><code class="plain">    			}</code></div>
<div class="line"><code class="plain">    		});</code></div>
<div class="line"><code class="plain">    	}</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">});</code></div>
</div>
</div> </div>
</div>
<div class="section section-2 " id="37551717_Subscribingtopushnotifications-Parsinganotificationpayload">
<h2 class="heading "><span>Parsing a notification payload</span></h2>
<p>
The notification payload that is delivered to the device is modified slightly structure is a bit different between Android and iOS, as shown below.    </p>
<p>
The original JSON payload:    </p>
<div xmlns="http://www.w3.org/1999/xhtml" class="confbox programlisting scroll-unprocessed">
<div class="defaultnew syntaxhighlighter">
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;title&quot;</code><code class="plain">: </code><code class="string">&quot;Example&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;alert&quot;</code><code class="plain">: </code><code class="string">&quot;Sample alert&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;icon&quot;</code><code class="plain">: </code><code class="string">&quot;little_star&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;badge&quot;</code><code class="plain">: </code><code class="value">3</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;sound&quot;</code><code class="plain">: </code><code class="string">&quot;door_bell&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;vibrate&quot;</code><code class="plain">: </code><code class="keyword">true</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;custom_field_1&quot;</code><code class="plain">: </code><code class="string">&quot;Appcelerator Cloud Services Rocks!&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;custom_field_2&quot;</code><code class="plain">: </code><code class="string">&quot;Hi Push&quot;</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
</div> <p>
iOS payload:    </p>
<div xmlns="http://www.w3.org/1999/xhtml" class="confbox programlisting scroll-unprocessed">
<div class="defaultnew syntaxhighlighter">
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;aps&quot;</code><code class="plain">: {</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;alert&quot;</code><code class="plain">: </code><code class="string">&quot;Sample alert&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;badge&quot;</code><code class="plain">: </code><code class="value">3</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;sound&quot;</code><code class="plain">: </code><code class="string">&quot;door_bell&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    },</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;title&quot;</code><code class="plain">: </code><code class="string">&quot;Example&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;icon&quot;</code><code class="plain">: </code><code class="string">&quot;little_star&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;vibrate&quot;</code><code class="plain">: </code><code class="keyword">true</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;custom_field_1&quot;</code><code class="plain">: </code><code class="string">&quot;Appcelerator Cloud Services Rocks!&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;custom_field_2&quot;</code><code class="plain">: </code><code class="string">&quot;Hi Push&quot;</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
</div> <p>
Android parsed payload:    </p>
<div xmlns="http://www.w3.org/1999/xhtml" class="confbox programlisting scroll-unprocessed">
<div class="defaultnew syntaxhighlighter">
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;android&quot;</code><code class="plain">: {</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;title&quot;</code><code class="plain">: </code><code class="string">&quot;Example&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;alert&quot;</code><code class="plain">: </code><code class="string">&quot;Sample alert&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;icon&quot;</code><code class="plain">: </code><code class="string">&quot;little_star&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;badge&quot;</code><code class="plain">: </code><code class="value">3</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;sound&quot;</code><code class="plain">: </code><code class="string">&quot;door_bell&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;vibrate&quot;</code><code class="plain">: </code><code class="keyword">true</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    },</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;custom_field_1&quot;</code><code class="plain">: </code><code class="string">&quot;Appcelerator Cloud Services Rocks!&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain"> </code><code class="string">&quot;custom_field_2&quot;</code><code class="plain">: </code><code class="string">&quot;Hi Push&quot;</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
</div> <p>
For example, in the following example the <tt class=" ">receivePush()</tt> method was previously assigned to the notification callback handler. The following code parses the alert string from the notification payload, and assigns it to a variable named <tt class=" ">alertString</tt>.    </p>
<div xmlns="http://www.w3.org/1999/xhtml" class="confbox programlisting scroll-unprocessed">
<div class="defaultnew syntaxhighlighter">
<div class="line"><code class="plain">var ostype = Titanium.Platform.osname;</code></div>
<div class="line"><code class="plain">var alertString;</code></div>
<div class="line"><code class="plain">function receivePush(e) {</code></div>
<div class="line"><code class="plain"> </code><code class="keyword">if</code><code class="plain">(ostype === </code><code class="string">&quot;android&quot;</code><code class="plain">){</code></div>
<div class="line"><code class="plain">    	alertString = JSON.parse(e.payload).android.alert;</code></div>
<div class="line"><code class="plain">	}</code></div>
<div class="line"><code class="plain"> </code><code class="keyword">if</code><code class="plain">(ostype === </code><code class="string">&quot;iphone&quot;</code><code class="plain"> || ostype === </code><code class="string">&quot;ipad&quot;</code><code class="plain">){</code></div>
<div class="line"><code class="plain">    	alertString = e.data.aps.alert;</code></div>
<div class="line"><code class="plain">	}</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
</div> </div>
<div class="section section-2 heading" id="37551717_Subscribingtopushnotifications-Moreexamples">
<h2 class="heading heading"><span>More examples</span></h2>
<p>
For another demonstration of the PushNotification API, run the Cloud demo app and select <strong class=" ">Push Notifications</strong>. The code for the Cloud demo is located in the Cloud module at &lt;PATH_TO_TITANIUM_SDK&gt;/modules/commonjs/ti.cloud/&lt;VERSION&gt;/example/.    </p>
</div>
</div>

</div>

</body>
</html>